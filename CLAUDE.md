# CLAUDE.md

This file provides guidance to Claude Code when working with code in this repository.

## What This Is

A multi-agent orchestration plugin for Claude Code. Provides persona-based workflows, planning and execution pipelines, specialist subagents, and continuation control. Pure-markdown plugin — no build step, no dependencies, no compiled code. All agents, skills, hooks, and docs are plain `.md` or `.json` files. Runtime scripts are stdlib-only Python.

## Running Locally

```bash
claude --plugin-dir ./claude-agent-kit --debug
```

## Testing

```bash
python3 -m pytest tests/test_validate.py -v
```

Validates: agent/skill frontmatter, `hooks.json` schema, Python script syntax, agent metadata fields (`category`, `costTier`), and bidirectional consistency between `agents/*.md` and `docs/agent-mapping.md`. Exits 0 on success, 1 on failure. Runs in CI via `.github/workflows/validate.yml`.

Python unit tests for the dynamic prompt generator:
```bash
python3 -m pytest tests/test_build_sections.py -v
```

## Architecture

### Agents (`agents/*.md`)

Each file has YAML frontmatter (`name`, `description`, `model`, `tools`, `maxTurns`) and a markdown system prompt body. Namespaced as `claude-agent-kit:<agent-name>`. Subagents also carry optional metadata fields (`category`, `costTier`, `keyTrigger`, `useWhen`, `avoidWhen`, `delegationDomains`) consumed by the dynamic prompt generation system.

Two categories:
- **Persona agents** (main-session injection via hooks): `sisyphus` (opus, orchestrator), `hephaestus` (opus, autonomous executor), `atlas` (sonnet, execution coordinator), `prometheus` (opus, planner).
- **Subagents** (forked specialists): `explore` (haiku, code search), `librarian` (sonnet, external research), `oracle` (opus, architecture advisor), `metis` (opus, pre-planning), `momus` (opus, plan review).

### Two-Layer Prompt Composition

Persona agents use a two-layer prompt system:
- **Static layer** (agent `.md` files): Identity, behavioral framework, workflow phases, constraints — everything that doesn't depend on runtime context.
- **Dynamic layer** (hook output): Agent routing tables, skill delegation guides, tool selection — generated by `scripts/build_sections.py` at SessionStart and UserPromptSubmit, based on which agents/skills are available.

Fallback: if Python is unavailable or the script errors, the expanded static `.md` body still provides the full behavioral framework (graceful degradation).

### Skills (`skills/*/SKILL.md`)

Each has YAML frontmatter (`name`, `description`) and a prompt template. Namespaced as `/claude-agent-kit:<skill-name>`. Use `$ARGUMENTS` for user input.

Categories:
- **Persona switches** (`sisyphus`, `hephaestus`, `atlas`, `prometheus`): Set `activePersona` in runtime state.
- **Workflow** (`plan`, `start-work`): Create plans under `.agent-kit/plans/` and execute from boulder state.
- **Continuation control** (`ulw`, `ralph-loop`, `stop-continuation`, `cancel-ralph`): Manage autonomous execution loops.
- **Utilities** (`handoff`, `selftest`): Context transfer and self-testing.

### Hooks (`hooks/hooks.json`)

Four hooks, all dispatched through `scripts/hook_router.py`:
- **SessionStart**: Injects active persona prompt + boulder resume context.
- **UserPromptSubmit**: Injects persona prompt + detects ultrawork (ULW) triggers.
- **PreToolUse**: Blocks destructive Bash commands; blocks code edits in `prometheus` persona.
- **Stop**: Blocks agent stop when boulder/ralph/ULW continuation is active (up to 8 blocks, then auto-disables).

### State Management (`.agent-kit/`)

Runtime state files (gitignored, not part of the plugin itself):
- `boulder.json`: Active plan tracking (`active`, `status`, `planPath`, `currentTask`).
- `plans/*.md`: Markdown checklists created by `/claude-agent-kit:plan`.
- `state/runtime.local.json`: Session state (`activePersona`, ULW flags, stop counters).
- `ralph-loop.local.md`: Iteration-bounded continuation loop state.

### Scripts (`scripts/`)

All stdlib-only Python (no pip dependencies for core scripts). Each module is importable AND has a CLI entry point via `if __name__ == "__main__":`.

- `hook_router.py`: Central hook dispatcher (fail-open on errors). Imports all other modules.
- `build_sections.py`: Dynamic prompt section generator. Scans agent/skill frontmatter, builds context-aware sections per persona.
- `detect.py`: Pattern-matches user prompts for ultrawork triggers and persona skill invocations.
- `sanitize.py`: Safe stdin JSON parsing for hooks with sensitive field redaction.
- `state.py`: Atomic JSON file I/O helpers (fail-open reads, locked writes).
- `telemetry.py`: Fire-and-forget Langfuse event/score emission.
- `prompt_version.py`: SHA256 hash computation for prompt regression detection.
- `_debug.py`: Shared debug/logging utilities (import-only).

### Model Routing (`docs/routing.md`)

All Anthropic-only:
- **haiku**: high-volume search/exploration (explore)
- **sonnet**: implementation, coordination (atlas, librarian)
- **opus**: architecture, planning, deep review (sisyphus, hephaestus, prometheus, oracle, metis, momus)

## Adding a New Agent

1. Create `agents/<name>.md` with required frontmatter: `name`, `description`, `model`, `tools`, `maxTurns`.
2. Add `category` field (required). For subagents, also add `costTier` and optionally `keyTrigger`, `useWhen`, `avoidWhen`, `delegationDomains`.
3. Add to `docs/agent-mapping.md` inventory table.
4. Follow model routing policy in `docs/routing.md`.
5. Optionally create a matching `skills/<name>/SKILL.md` entrypoint.

## Adding a New Skill

1. Create `skills/<name>/SKILL.md` with required frontmatter: `name`, `description`.
2. Use `$ARGUMENTS` in the prompt body for user input.
3. Optional frontmatter keys: `model`, `context` (e.g. `fork` to run in a forked subagent), `agent` (paired with `context: fork`), `allowed-tools`, `disable-model-invocation` (set `true` for manual-only skills).

## Key Conventions

- Agent prompts must use Claude Code tool names (`Read`, `Edit`, `Write`, `Bash`, `Grep`, `Glob`, `Task`, `WebFetch`).
- Read-only agents use `disallowedTools: Edit, Write` and/or `permissionMode: plan`.
- Project-local settings go in `.claude/settings.local.json`, never global user settings.
- All Python scripts must have `#!/usr/bin/env python3`, be executable (`chmod +x`), and use only stdlib imports.
- Hook router is fail-open: on any error, it logs to stderr and exits 0 (never blocks the user).
- Python module filenames use underscores (`hook_router.py`) to enable imports.
